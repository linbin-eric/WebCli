# 目标

设计并实现一个可以在 Web 上查看和操作本地终端的应用，支持本地和远程 Web 同时访问，并提供细粒度的权限控制。


# 整体架构

```
                                    ┌─────────────────┐
                                    │  远端 WebServer  │
                                    │   (只读/受控)    │
                                    └────────┬────────┘
                                             │ TCP
                                             │ (输出 + 受控输入)
                                             ▼
┌──────────┐      ┌─────────────────────────────────────────┐      ┌──────────────┐
│ 本地终端  │◄────►│                 Agent                   │◄────►│ 本地 Web 服务 │
└──────────┘      │  ┌─────┐  ┌─────┐  ┌─────┐              │      │  (完全控制)   │
                  │  │PTY 1│  │PTY 2│  │PTY 3│  ...         │      └──────────────┘
                  │  └─────┘  └─────┘  └─────┘              │
                  │                                         │
                  │  权限管理：                              │
                  │  - 每个 PTY 可独立配置远端输入权限         │
                  └─────────────────────────────────────────┘
```


# 核心组件

## 1. Agent（本地代理）

- **PTY 管理**：创建和管理多个伪终端（PTY），可在 PTY 中执行任意命令（如 claude、vim、bash 等）
- **本地 Web 服务**：绑定 127.0.0.1，提供完全控制能力
- **TCP 客户端**：连接远端 WebServer，转发 PTY 输出
- **权限控制**：管理每个 PTY 的远端输入权限

## 2. 远端 WebServer

- **TCP 服务端**：接收 Agent 连接，使用 Jnet 框架
- **Web 服务**：对外提供终端查看界面，使用 JfireBoot 框架
- **消息转发**：将用户输入转发给 Agent（由 Agent 决定是否接受）

## 3. Web 前端

- 使用 xterm.js 模拟终端界面
- 通过 WebSocket 与后端通信

### WebSocket 通信内容

**前端 → 后端：**
- 终端输入（用户键盘输入的字符/按键）
- 终端大小调整（resize 事件，行数/列数）
- PTY 管理指令（本地 Web：创建、关闭、切换 PTY）
- 权限管理指令（本地 Web：授权/取消远端输入权限）

**后端 → 前端：**
- 终端输出（PTY 产生的字符流，包含 ANSI 转义序列）
- PTY 列表/状态更新
- 权限状态变更通知


# 权限模型

| 操作 | 本地终端 | 本地 Web | 远端 Web |
|-----|---------|---------|---------|
| 查看 PTY 输出 | ✓ | ✓ | ✓ |
| 输入到 PTY | ✓ | ✓ | 默认 ✗，可授权 |
| 管理 PTY（创建/关闭） | ✓ | ✓ | ✗ |
| 授权远端输入 | - | ✓ | ✗ |

**安全设计要点：**
1. 本地 Web 服务绑定 127.0.0.1，仅本机可访问
2. 远端输入需要 Agent 侧授权，即使远端发送了输入，Agent 不接受则无效
3. 授权粒度到 PTY 级别，可以只开放特定会话给远端


# 技术选型

1. Agent 和远端 WebServer 采用 TCP 自定义协议通信，使用 Jnet 框架
2. WebServer 的 Web 服务使用 JfireBoot 框架
3. PTY 管理使用 pty4j 库
4. 前端终端模拟使用 xterm.js
