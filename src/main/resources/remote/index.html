<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebCli Terminal - Remote</title>
    <link rel="stylesheet" href="lib/xterm.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1e1e1e;
            color: #fff;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .toolbar {
            background: #2d2d2d;
            padding: 8px 16px;
            display: flex;
            gap: 8px;
            align-items: center;
            border-bottom: 1px solid #404040;
        }
        .toolbar button {
            background: #0e639c;
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .toolbar button:hover { background: #1177bb; }
        .toolbar button:disabled { background: #555; cursor: not-allowed; }
        .toolbar .title {
            font-size: 14px;
            color: #4ec9b0;
            margin-right: 16px;
        }
        .tabs {
            display: flex;
            gap: 2px;
            margin-left: 16px;
        }
        .tab {
            background: #2d2d2d;
            color: #ccc;
            border: none;
            padding: 6px 16px;
            cursor: pointer;
            font-size: 13px;
            border-radius: 4px 4px 0 0;
        }
        .tab.active { background: #1e1e1e; color: #fff; }
        .tab .close {
            margin-left: 8px;
            opacity: 0.6;
        }
        .tab .close:hover { opacity: 1; }
        #terminal-container {
            flex: 1;
            padding: 8px;
        }
        .status {
            color: #888;
            font-size: 12px;
            margin-left: auto;
        }
        .status.connected { color: #4ec9b0; }
        .status.disconnected { color: #f14c4c; }
        .pty-list {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2d2d2d;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 16px;
            min-width: 300px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
            z-index: 1000;
            display: none;
        }
        .pty-list.show { display: block; }
        .pty-list h3 {
            margin-bottom: 12px;
            font-size: 16px;
            color: #4ec9b0;
        }
        .pty-list-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .pty-list-item:hover { background: #094771; }
        .pty-list-item .name { font-size: 14px; }
        .pty-list-item .agent { font-size: 12px; color: #888; }
        .pty-list-empty {
            color: #888;
            text-align: center;
            padding: 20px;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        .overlay.show { display: block; }
        .theme-select {
            background: #3c3c3c;
            color: #fff;
            border: 1px solid #555;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            margin-left: auto;
            margin-right: 8px;
        }
        .theme-select:hover {
            background: #4c4c4c;
        }
        .shortcuts {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }
        .shortcuts button {
            background: #0e639c;
            color: #fff;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .shortcuts button:hover { background: #1177bb; }
        .shortcuts button:active { background: #0d5a8c; }
        .arrow-keys {
            display: grid;
            grid-template-columns: repeat(3, 40px);
            grid-template-rows: repeat(2, 40px);
            gap: 4px;
        }
        .arrow-keys button {
            padding: 8px;
            font-size: 16px;
        }
        .arrow-keys .arrow-up { grid-column: 2; grid-row: 1; }
        .arrow-keys .arrow-left { grid-column: 1; grid-row: 2; }
        .arrow-keys .arrow-down { grid-column: 2; grid-row: 2; }
        .arrow-keys .arrow-right { grid-column: 3; grid-row: 2; }
    </style>
</head>
<body>
<div class="toolbar">
    <span class="title">Remote Terminal</span>
    <button id="btn-connect">连接终端</button>
    <div class="tabs" id="tabs"></div>
    <select class="theme-select" id="theme-select">
        <option value="dark">深色主题</option>
        <option value="light">浅色主题</option>
        <option value="eye-care">护眼主题</option>
    </select>
    <span class="status disconnected" id="status">未连接</span>
</div>
<div id="terminal-container"></div>
<div class="overlay" id="overlay"></div>
<div class="pty-list" id="pty-list">
    <h3>可用终端</h3>
    <div id="pty-list-content"></div>
</div>
<div class="shortcuts">
    <div class="arrow-keys">
        <button class="arrow-up" id="btn-arrow-up">↑</button>
        <button class="arrow-left" id="btn-arrow-left">←</button>
        <button class="arrow-down" id="btn-arrow-down">↓</button>
        <button class="arrow-right" id="btn-arrow-right">→</button>
    </div>
    <button id="btn-enter">Shift+Enter</button>
    <button id="btn-ctrl-c">Ctrl+C</button>
    <button id="btn-ctrl-v">Ctrl+V</button>
</div>

<script src="lib/xterm.min.js"></script>
<script src="lib/xterm-addon-fit.min.js"></script>
<script>
    const MessageType = {
        PTY_OUTPUT: 'PTY_OUTPUT',
        PTY_INPUT: 'PTY_INPUT',
        PTY_RESIZE: 'PTY_RESIZE',
        PTY_CLOSE: 'PTY_CLOSE',
        PTY_REMOTE_LIST: 'PTY_REMOTE_LIST',
        PTY_ATTACH: 'PTY_ATTACH',
        PTY_VISIBILITY_DISABLED: 'PTY_VISIBILITY_DISABLED',
        ERROR: 'ERROR',
        SUCCESS: 'SUCCESS'
    };

    const themes = {
        dark: {
            background: '#1e1e1e',
            foreground: '#d4d4d4',
            cursor: '#d4d4d4',
            selectionBackground: '#264f78'
        },
        light: {
            background: '#ffffff',
            foreground: '#333333',
            cursor: '#333333',
            selectionBackground: '#add6ff',
            black: '#000000',
            red: '#c91b00',
            green: '#00a000',
            yellow: '#a08000',
            blue: '#0225c7',
            magenta: '#c930c7',
            cyan: '#00a0a0',
            white: '#555555',
            brightBlack: '#676767',
            brightRed: '#ff6d67',
            brightGreen: '#00c200',
            brightYellow: '#c7c400',
            brightBlue: '#6871ff',
            brightMagenta: '#ff76ff',
            brightCyan: '#00c5c7',
            brightWhite: '#333333'
        },
        'eye-care': {
            background: '#f5f0e1',
            foreground: '#5b4636',
            cursor: '#5b4636',
            selectionBackground: '#d4c4a8',
            black: '#000000',
            red: '#c91b00',
            green: '#00a000',
            yellow: '#a08000',
            blue: '#0225c7',
            magenta: '#c930c7',
            cyan: '#00a0a0',
            white: '#555555',
            brightBlack: '#676767',
            brightRed: '#ff6d67',
            brightGreen: '#00c200',
            brightYellow: '#c0a000',
            brightBlue: '#6871ff',
            brightMagenta: '#ff76ff',
            brightCyan: '#00a0a0',
            brightWhite: '#333333'
        }
    };

    class RemoteTerminal {
        constructor() {
            this.ws = null;
            this.terminals = new Map();
            this.fitAddons = new Map();
            this.terminalNames = new Map();
            this.currentPtyId = null;
            this.currentTheme = localStorage.getItem('webcli-theme') || 'dark';

            this.init();
        }

        init() {
            this.connect();
            this.initShortcuts();
            this.initThemeSelector();

            document.getElementById('btn-connect').addEventListener('click', () => this.showPtyList());
            document.getElementById('overlay').addEventListener('click', () => this.hidePtyList());
            window.addEventListener('resize', () => this.fitTerminal());
        }

        initShortcuts() {
            document.getElementById('btn-arrow-up').addEventListener('click', () => {
                if (this.currentPtyId) {
                    const encoded = btoa('\x1b[A');
                    this.send({ type: MessageType.PTY_INPUT, ptyId: this.currentPtyId, data: encoded });
                }
            });

            document.getElementById('btn-arrow-down').addEventListener('click', () => {
                if (this.currentPtyId) {
                    const encoded = btoa('\x1b[B');
                    this.send({ type: MessageType.PTY_INPUT, ptyId: this.currentPtyId, data: encoded });
                }
            });

            document.getElementById('btn-arrow-right').addEventListener('click', () => {
                if (this.currentPtyId) {
                    const encoded = btoa('\x1b[C');
                    this.send({ type: MessageType.PTY_INPUT, ptyId: this.currentPtyId, data: encoded });
                }
            });

            document.getElementById('btn-arrow-left').addEventListener('click', () => {
                if (this.currentPtyId) {
                    const encoded = btoa('\x1b[D');
                    this.send({ type: MessageType.PTY_INPUT, ptyId: this.currentPtyId, data: encoded });
                }
            });

            document.getElementById('btn-enter').addEventListener('click', () => {
                if (this.currentPtyId) {
                    const encoded = btoa('\n');
                    this.send({ type: MessageType.PTY_INPUT, ptyId: this.currentPtyId, data: encoded });
                }
            });

            document.getElementById('btn-ctrl-c').addEventListener('click', () => {
                if (this.currentPtyId) {
                    const encoded = btoa('\x03');
                    this.send({ type: MessageType.PTY_INPUT, ptyId: this.currentPtyId, data: encoded });
                }
            });

            document.getElementById('btn-ctrl-v').addEventListener('click', async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    if (this.currentPtyId && text) {
                        const encoded = btoa(unescape(encodeURIComponent(text)));
                        this.send({ type: MessageType.PTY_INPUT, ptyId: this.currentPtyId, data: encoded });
                    }
                } catch (e) {
                    console.error('粘贴失败:', e);
                }
            });
        }

        initThemeSelector() {
            const selector = document.getElementById('theme-select');
            selector.value = this.currentTheme;
            selector.addEventListener('change', (e) => {
                this.currentTheme = e.target.value;
                localStorage.setItem('webcli-theme', this.currentTheme);
                this.applyTheme();
            });
        }

        applyTheme() {
            const theme = themes[this.currentTheme];
            document.body.style.background = theme.background;
            document.getElementById('terminal-container').style.background = theme.background;
            this.terminals.forEach((term) => {
                term.options.theme = theme;
            });
        }

        connect() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${location.host}/ws`;
            this.ws = new WebSocket(wsUrl);

            this.ws.onopen = () => {
                this.updateStatus(true);
            };

            this.ws.onmessage = (e) => {
                this.handleMessage(JSON.parse(e.data));
            };

            this.ws.onclose = () => {
                this.updateStatus(false);
                setTimeout(() => this.connect(), 3000);
            };

            this.ws.onerror = (e) => console.error('WebSocket error:', e);
        }

        handleMessage(msg) {
            switch (msg.type) {
                case MessageType.PTY_OUTPUT:
                    const term = this.terminals.get(msg.ptyId);
                    if (term && msg.data) {
                        const decoded = atob(msg.data);
                        const bytes = Uint8Array.from(decoded, c => c.charCodeAt(0));
                        const text = new TextDecoder('utf-8').decode(bytes);
                        term.write(text);
                    }
                    break;
                case MessageType.PTY_REMOTE_LIST:
                    this.displayPtyList(JSON.parse(msg.data));
                    break;
                case MessageType.SUCCESS:
                    if (msg.ptyId && !this.terminals.has(msg.ptyId)) {
                        // 附加成功，创建终端
                        this.addTerminal(msg.ptyId);
                    }
                    break;
                case MessageType.PTY_VISIBILITY_DISABLED:
                    this.handleVisibilityDisabled(msg.ptyId);
                    break;
                case MessageType.ERROR:
                    console.error('Server error:', msg.data);
                    alert('错误: ' + msg.data);
                    break;
            }
        }

        handleVisibilityDisabled(ptyId) {
            const name = this.terminalNames.get(ptyId) || ptyId;
            // 清理本地终端
            this.terminals.get(ptyId)?.dispose();
            this.terminals.delete(ptyId);
            this.fitAddons.delete(ptyId);
            this.terminalNames.delete(ptyId);
            document.querySelector(`.tab[data-pty-id="${ptyId}"]`)?.remove();

            // 切换到其他终端
            if (this.currentPtyId === ptyId) {
                const firstPty = this.terminals.keys().next().value;
                if (firstPty) {
                    this.switchTerminal(firstPty);
                } else {
                    this.currentPtyId = null;
                    document.getElementById('terminal-container').innerHTML = '';
                }
            }

            // 提示用户
            alert(`终端 "${name}" 已被本地关闭远端可见`);
        }

        showPtyList() {
            this.send({ type: MessageType.PTY_REMOTE_LIST });
            document.getElementById('overlay').classList.add('show');
            document.getElementById('pty-list').classList.add('show');
        }

        hidePtyList() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('pty-list').classList.remove('show');
        }

        displayPtyList(list) {
            const content = document.getElementById('pty-list-content');
            if (!list || list.length === 0) {
                content.innerHTML = '<div class="pty-list-empty">暂无可用终端</div>';
                return;
            }

            content.innerHTML = list.map(pty => {
                const [agentId, ptyId] = pty.id.split(':');
                const shortAgentId = agentId.substring(0, 8);
                return `
                    <div class="pty-list-item" data-pty-id="${pty.id}">
                        <span class="name">${pty.name}</span>
                        <span class="agent">Agent: ${shortAgentId}...</span>
                    </div>
                `;
            }).join('');

            content.querySelectorAll('.pty-list-item').forEach(item => {
                item.addEventListener('click', () => {
                    const ptyId = item.dataset.ptyId;
                    const name = item.querySelector('.name').textContent;
                    this.attachPty(ptyId, name);
                    this.hidePtyList();
                });
            });
        }

        attachPty(ptyId, name) {
            if (this.terminals.has(ptyId)) {
                this.switchTerminal(ptyId);
                return;
            }
            this.terminalNames.set(ptyId, name);
            this.send({ type: MessageType.PTY_ATTACH, ptyId });
        }

        addTerminal(ptyId) {
            const theme = themes[this.currentTheme];
            const term = new Terminal({
                cursorBlink: true,
                fontSize: 14,
                fontFamily: '"Maple Mono NF", "MesloLGS NF", "Hack Nerd Font", Menlo, Monaco, "Courier New", monospace',
                theme: theme
            });

            const fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
            this.terminals.set(ptyId, term);
            this.fitAddons.set(ptyId, fitAddon);

            term.onData(data => {
                const encoded = btoa(unescape(encodeURIComponent(data)));
                this.send({ type: MessageType.PTY_INPUT, ptyId, data: encoded });
            });

            term.onResize(({ cols, rows }) => {
                this.send({ type: MessageType.PTY_RESIZE, ptyId, cols, rows });
            });

            this.addTab(ptyId);
            this.switchTerminal(ptyId);
        }

        addTab(ptyId) {
            const tabs = document.getElementById('tabs');
            const tab = document.createElement('button');
            tab.className = 'tab';
            tab.dataset.ptyId = ptyId;
            const name = this.terminalNames.get(ptyId) || ptyId;
            tab.innerHTML = `<span class="tab-name">${name}</span><span class="close">×</span>`;

            tab.addEventListener('click', (e) => {
                if (e.target.classList.contains('close')) {
                    this.closePty(ptyId);
                } else {
                    this.switchTerminal(ptyId);
                }
            });

            tabs.appendChild(tab);
        }

        switchTerminal(ptyId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[data-pty-id="${ptyId}"]`)?.classList.add('active');

            const container = document.getElementById('terminal-container');
            container.innerHTML = '';

            const term = this.terminals.get(ptyId);
            const fitAddon = this.fitAddons.get(ptyId);
            if (term && fitAddon) {
                term.open(container);
                fitAddon.fit();
                term.focus();
                this.currentPtyId = ptyId;

                this.send({
                    type: MessageType.PTY_RESIZE,
                    ptyId,
                    cols: term.cols,
                    rows: term.rows
                });
            }
        }

        closePty(ptyId) {
            this.send({ type: MessageType.PTY_CLOSE, ptyId });
            this.terminals.get(ptyId)?.dispose();
            this.terminals.delete(ptyId);
            this.fitAddons.delete(ptyId);
            this.terminalNames.delete(ptyId);

            document.querySelector(`.tab[data-pty-id="${ptyId}"]`)?.remove();

            if (this.currentPtyId === ptyId) {
                const firstPty = this.terminals.keys().next().value;
                if (firstPty) {
                    this.switchTerminal(firstPty);
                } else {
                    this.currentPtyId = null;
                }
            }
        }

        fitTerminal() {
            if (this.currentPtyId) {
                const fitAddon = this.fitAddons.get(this.currentPtyId);
                const term = this.terminals.get(this.currentPtyId);
                if (fitAddon && term) {
                    fitAddon.fit();
                    this.send({
                        type: MessageType.PTY_RESIZE,
                        ptyId: this.currentPtyId,
                        cols: term.cols,
                        rows: term.rows
                    });
                }
            }
        }

        send(msg) {
            if (this.ws?.readyState === WebSocket.OPEN) {
                this.ws.send(JSON.stringify(msg));
            }
        }

        updateStatus(connected) {
            const status = document.getElementById('status');
            status.textContent = connected ? '已连接' : '未连接';
            status.className = `status ${connected ? 'connected' : 'disconnected'}`;
        }
    }

    new RemoteTerminal();
</script>
</body>
</html>
