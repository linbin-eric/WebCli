<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebCli Terminal - Remote</title>
    <link rel="stylesheet" href="lib/xterm.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1e1e1e;
            color: #fff;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .toolbar {
            background: #2d2d2d;
            padding: 8px 16px;
            display: flex;
            gap: 8px;
            align-items: center;
            border-bottom: 1px solid #404040;
        }
        .toolbar button {
            background: #0e639c;
            color: #fff;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .toolbar button:hover { background: #1177bb; }
        .toolbar button:disabled { background: #555; cursor: not-allowed; }
        .toolbar .title {
            font-size: 14px;
            color: #4ec9b0;
            margin-right: 16px;
        }
        .tabs {
            display: flex;
            gap: 2px;
            margin-left: 16px;
        }
        .tab {
            background: #2d2d2d;
            color: #ccc;
            border: none;
            padding: 6px 16px;
            cursor: pointer;
            font-size: 13px;
            border-radius: 4px 4px 0 0;
        }
        .tab.active { background: #1e1e1e; color: #fff; }
        .tab .close {
            margin-left: 8px;
            opacity: 0.6;
        }
        .tab .close:hover { opacity: 1; }
        #terminal-container {
            flex: 1;
            padding: 8px;
        }
        .status {
            color: #888;
            font-size: 12px;
            margin-left: auto;
        }
        .status.connected { color: #4ec9b0; }
        .status.disconnected { color: #f14c4c; }
        .pty-list {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2d2d2d;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 16px;
            min-width: 300px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
            z-index: 1000;
            display: none;
        }
        .pty-list.show { display: block; }
        .pty-list h3 {
            margin-bottom: 12px;
            font-size: 16px;
            color: #4ec9b0;
        }
        .pty-list-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .pty-list-item:hover { background: #094771; }
        .pty-list-item .name { font-size: 14px; }
        .pty-list-item .agent { font-size: 12px; color: #888; }
        .pty-list-empty {
            color: #888;
            text-align: center;
            padding: 20px;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        .overlay.show { display: block; }
        .theme-select {
            background: #3c3c3c;
            color: #fff;
            border: 1px solid #555;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            margin-left: auto;
            margin-right: 8px;
        }
        .theme-select:hover {
            background: #4c4c4c;
        }
        .shortcuts {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }
        .shortcuts button {
            background: #0e639c;
            color: #fff;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .shortcuts button:hover { background: #1177bb; }
        .shortcuts button:active { background: #0d5a8c; }
        .arrow-keys {
            display: grid;
            grid-template-columns: repeat(3, 40px);
            grid-template-rows: repeat(2, 40px);
            gap: 4px;
        }
        .arrow-keys button {
            padding: 8px;
            font-size: 16px;
        }
        .arrow-keys .arrow-up { grid-column: 2; grid-row: 1; }
        .arrow-keys .arrow-left { grid-column: 1; grid-row: 2; }
        .arrow-keys .arrow-down { grid-column: 2; grid-row: 2; }
        .arrow-keys .arrow-right { grid-column: 3; grid-row: 2; }
        /* 登录对话框样式 */
        .login-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2d2d2d;
            border: 1px solid #404040;
            border-radius: 8px;
            padding: 24px;
            min-width: 320px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.4);
            z-index: 1001;
        }
        .login-dialog h3 {
            margin-bottom: 20px;
            font-size: 18px;
            color: #4ec9b0;
            text-align: center;
        }
        .login-dialog .form-group {
            margin-bottom: 16px;
        }
        .login-dialog label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            color: #ccc;
        }
        .login-dialog input {
            width: 100%;
            padding: 10px 12px;
            background: #1e1e1e;
            border: 1px solid #404040;
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
        }
        .login-dialog input:focus {
            outline: none;
            border-color: #0e639c;
        }
        .login-dialog .login-btn {
            width: 100%;
            padding: 10px;
            background: #0e639c;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 8px;
        }
        .login-dialog .login-btn:hover {
            background: #1177bb;
        }
        .login-dialog .login-btn:disabled {
            background: #555;
            cursor: not-allowed;
        }
        .login-dialog .error-msg {
            color: #f14c4c;
            font-size: 12px;
            margin-top: 12px;
            text-align: center;
            min-height: 18px;
        }
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
        }
    </style>
</head>
<body>
<div class="toolbar">
    <span class="title">Remote Terminal</span>
    <button id="btn-connect">连接终端</button>
    <div class="tabs" id="tabs"></div>
    <select class="theme-select" id="theme-select">
        <option value="dark">深色主题</option>
        <option value="light">浅色主题</option>
        <option value="eye-care">护眼主题</option>
    </select>
    <span class="status disconnected" id="status">未连接</span>
</div>
<div id="terminal-container"></div>
<div class="overlay" id="overlay"></div>
<div class="pty-list" id="pty-list">
    <h3>可用终端</h3>
    <div id="pty-list-content"></div>
</div>
<!-- 登录对话框 -->
<div class="login-overlay" id="login-overlay"></div>
<div class="login-dialog" id="login-dialog">
    <h3>远程终端登录</h3>
    <div class="form-group">
        <label for="username">用户名</label>
        <input type="text" id="username" placeholder="请输入用户名" autocomplete="username">
    </div>
    <div class="form-group">
        <label for="password">密码</label>
        <input type="password" id="password" placeholder="请输入密码" autocomplete="current-password">
    </div>
    <button class="login-btn" id="btn-login">登录</button>
    <div class="error-msg" id="login-error"></div>
</div>
<div class="shortcuts">
    <div class="arrow-keys">
        <button class="arrow-up" id="btn-arrow-up">↑</button>
        <button class="arrow-left" id="btn-arrow-left">←</button>
        <button class="arrow-down" id="btn-arrow-down">↓</button>
        <button class="arrow-right" id="btn-arrow-right">→</button>
    </div>
    <button id="btn-enter">Shift+Enter</button>
    <button id="btn-ctrl-c">Ctrl+C</button>
    <button id="btn-ctrl-v">Ctrl+V</button>
</div>

<script src="lib/xterm.min.js"></script>
<script src="lib/xterm-addon-fit.min.js"></script>
<script>
    const MessageType = {
        PTY_OUTPUT: 'PTY_OUTPUT',
        PTY_INPUT: 'PTY_INPUT',
        PTY_RESIZE: 'PTY_RESIZE',
        PTY_DETACH: 'PTY_DETACH',
        PTY_ATTACH: 'PTY_ATTACH',
        PTY_VISIBILITY_DISABLED: 'PTY_VISIBILITY_DISABLED',
        AUTH: 'AUTH',
        AUTH_SUCCESS: 'AUTH_SUCCESS',
        AUTH_FAILED: 'AUTH_FAILED',
        ERROR: 'ERROR',
        SUCCESS: 'SUCCESS'
    };

    const themes = {
        dark: {
            background: '#1e1e1e',
            foreground: '#d4d4d4',
            cursor: '#d4d4d4',
            selectionBackground: '#264f78'
        },
        light: {
            background: '#ffffff',
            foreground: '#333333',
            cursor: '#333333',
            selectionBackground: '#add6ff',
            black: '#000000',
            red: '#c91b00',
            green: '#00a000',
            yellow: '#a08000',
            blue: '#0225c7',
            magenta: '#c930c7',
            cyan: '#00a0a0',
            white: '#555555',
            brightBlack: '#676767',
            brightRed: '#ff6d67',
            brightGreen: '#00c200',
            brightYellow: '#c7c400',
            brightBlue: '#6871ff',
            brightMagenta: '#ff76ff',
            brightCyan: '#00c5c7',
            brightWhite: '#333333'
        },
        'eye-care': {
            background: '#f5f0e1',
            foreground: '#5b4636',
            cursor: '#5b4636',
            selectionBackground: '#d4c4a8',
            black: '#000000',
            red: '#c91b00',
            green: '#00a000',
            yellow: '#a08000',
            blue: '#0225c7',
            magenta: '#c930c7',
            cyan: '#00a0a0',
            white: '#555555',
            brightBlack: '#676767',
            brightRed: '#ff6d67',
            brightGreen: '#00c200',
            brightYellow: '#c0a000',
            brightBlue: '#6871ff',
            brightMagenta: '#ff76ff',
            brightCyan: '#00a0a0',
            brightWhite: '#333333'
        }
    };

    class RemoteTerminal {
        constructor() {
            this.ws = null;
            this.terminals = new Map();
            this.fitAddons = new Map();
            this.terminalNames = new Map();
            this.currentPtyId = null;
            this.currentTheme = localStorage.getItem('webcli-theme') || 'dark';
            this.authToken = localStorage.getItem('webcli-auth-token') || null;
            this.wsAuthenticated = false;

            this.init();
        }

        init() {
            this.connect();
            this.initShortcuts();
            this.initThemeSelector();
            this.initLogin();

            document.getElementById('btn-connect').addEventListener('click', () => this.showPtyList());
            document.getElementById('overlay').addEventListener('click', () => this.hidePtyList());
            window.addEventListener('resize', () => this.fitTerminal());
        }

        initLogin() {
            const loginBtn = document.getElementById('btn-login');
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');

            loginBtn.addEventListener('click', () => this.doLogin());

            // 回车键登录
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') this.doLogin();
            });
            usernameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') passwordInput.focus();
            });
        }

        showLoginDialog() {
            document.getElementById('login-overlay').style.display = 'block';
            document.getElementById('login-dialog').style.display = 'block';
            document.getElementById('login-error').textContent = '';
            document.getElementById('username').focus();
        }

        hideLoginDialog() {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('login-dialog').style.display = 'none';
        }

        async doLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('login-error');

            if (!username || !password) {
                errorEl.textContent = '请输入用户名和密码';
                return;
            }

            // 生成随机盐
            const salt = this.generateSalt();
            // 计算 MD5(password + salt)
            const passwordHash = this.md5(password + salt);

            // 禁用登录按钮
            const loginBtn = document.getElementById('btn-login');
            loginBtn.disabled = true;
            loginBtn.textContent = '登录中...';

            try {
                const response = await fetch('/api/remote/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, passwordHash, salt })
                });
                const result = await response.json();

                if (result.success && result.token) {
                    this.authToken = result.token;
                    localStorage.setItem('webcli-auth-token', result.token);
                    this.hideLoginDialog();
                    document.getElementById('password').value = '';
                    // 通过 WebSocket 发送 token 进行认证
                    this.authenticateWebSocket();
                } else {
                    errorEl.textContent = result.message || '登录失败';
                }
            } catch (e) {
                console.error('登录失败:', e);
                errorEl.textContent = '登录失败，请检查网络连接';
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = '登录';
            }
        }

        authenticateWebSocket() {
            if (this.ws?.readyState === WebSocket.OPEN && this.authToken) {
                this.send({ type: MessageType.AUTH, data: this.authToken });
            }
        }

        generateSalt() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let salt = '';
            for (let i = 0; i < 16; i++) {
                salt += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return salt;
        }

        // MD5 实现
        md5(string) {
            function rotateLeft(value, shift) {
                return (value << shift) | (value >>> (32 - shift));
            }

            function addUnsigned(x, y) {
                const x8 = x & 0x80000000;
                const y8 = y & 0x80000000;
                const x4 = x & 0x40000000;
                const y4 = y & 0x40000000;
                const result = (x & 0x3FFFFFFF) + (y & 0x3FFFFFFF);
                if (x4 & y4) return result ^ 0x80000000 ^ x8 ^ y8;
                if (x4 | y4) {
                    if (result & 0x40000000) return result ^ 0xC0000000 ^ x8 ^ y8;
                    return result ^ 0x40000000 ^ x8 ^ y8;
                }
                return result ^ x8 ^ y8;
            }

            function F(x, y, z) { return (x & y) | (~x & z); }
            function G(x, y, z) { return (x & z) | (y & ~z); }
            function H(x, y, z) { return x ^ y ^ z; }
            function I(x, y, z) { return y ^ (x | ~z); }

            function FF(a, b, c, d, x, s, ac) {
                a = addUnsigned(a, addUnsigned(addUnsigned(F(b, c, d), x), ac));
                return addUnsigned(rotateLeft(a, s), b);
            }
            function GG(a, b, c, d, x, s, ac) {
                a = addUnsigned(a, addUnsigned(addUnsigned(G(b, c, d), x), ac));
                return addUnsigned(rotateLeft(a, s), b);
            }
            function HH(a, b, c, d, x, s, ac) {
                a = addUnsigned(a, addUnsigned(addUnsigned(H(b, c, d), x), ac));
                return addUnsigned(rotateLeft(a, s), b);
            }
            function II(a, b, c, d, x, s, ac) {
                a = addUnsigned(a, addUnsigned(addUnsigned(I(b, c, d), x), ac));
                return addUnsigned(rotateLeft(a, s), b);
            }

            function convertToWordArray(str) {
                const utf8 = unescape(encodeURIComponent(str));
                const len = utf8.length;
                const numWords = (((len + 8) >>> 6) + 1) << 4;
                const words = new Array(numWords).fill(0);
                for (let i = 0; i < len; i++) {
                    words[i >>> 2] |= utf8.charCodeAt(i) << ((i % 4) << 3);
                }
                words[len >>> 2] |= 0x80 << ((len % 4) << 3);
                words[numWords - 2] = len << 3;
                return words;
            }

            function wordToHex(value) {
                let hex = '';
                for (let i = 0; i <= 3; i++) {
                    const byte = (value >>> (i << 3)) & 0xFF;
                    hex += ('0' + byte.toString(16)).slice(-2);
                }
                return hex;
            }

            const x = convertToWordArray(string);
            let a = 0x67452301, b = 0xEFCDAB89, c = 0x98BADCFE, d = 0x10325476;

            const S11 = 7, S12 = 12, S13 = 17, S14 = 22;
            const S21 = 5, S22 = 9, S23 = 14, S24 = 20;
            const S31 = 4, S32 = 11, S33 = 16, S34 = 23;
            const S41 = 6, S42 = 10, S43 = 15, S44 = 21;

            for (let k = 0; k < x.length; k += 16) {
                const AA = a, BB = b, CC = c, DD = d;

                a = FF(a, b, c, d, x[k], S11, 0xD76AA478);
                d = FF(d, a, b, c, x[k + 1], S12, 0xE8C7B756);
                c = FF(c, d, a, b, x[k + 2], S13, 0x242070DB);
                b = FF(b, c, d, a, x[k + 3], S14, 0xC1BDCEEE);
                a = FF(a, b, c, d, x[k + 4], S11, 0xF57C0FAF);
                d = FF(d, a, b, c, x[k + 5], S12, 0x4787C62A);
                c = FF(c, d, a, b, x[k + 6], S13, 0xA8304613);
                b = FF(b, c, d, a, x[k + 7], S14, 0xFD469501);
                a = FF(a, b, c, d, x[k + 8], S11, 0x698098D8);
                d = FF(d, a, b, c, x[k + 9], S12, 0x8B44F7AF);
                c = FF(c, d, a, b, x[k + 10], S13, 0xFFFF5BB1);
                b = FF(b, c, d, a, x[k + 11], S14, 0x895CD7BE);
                a = FF(a, b, c, d, x[k + 12], S11, 0x6B901122);
                d = FF(d, a, b, c, x[k + 13], S12, 0xFD987193);
                c = FF(c, d, a, b, x[k + 14], S13, 0xA679438E);
                b = FF(b, c, d, a, x[k + 15], S14, 0x49B40821);

                a = GG(a, b, c, d, x[k + 1], S21, 0xF61E2562);
                d = GG(d, a, b, c, x[k + 6], S22, 0xC040B340);
                c = GG(c, d, a, b, x[k + 11], S23, 0x265E5A51);
                b = GG(b, c, d, a, x[k], S24, 0xE9B6C7AA);
                a = GG(a, b, c, d, x[k + 5], S21, 0xD62F105D);
                d = GG(d, a, b, c, x[k + 10], S22, 0x2441453);
                c = GG(c, d, a, b, x[k + 15], S23, 0xD8A1E681);
                b = GG(b, c, d, a, x[k + 4], S24, 0xE7D3FBC8);
                a = GG(a, b, c, d, x[k + 9], S21, 0x21E1CDE6);
                d = GG(d, a, b, c, x[k + 14], S22, 0xC33707D6);
                c = GG(c, d, a, b, x[k + 3], S23, 0xF4D50D87);
                b = GG(b, c, d, a, x[k + 8], S24, 0x455A14ED);
                a = GG(a, b, c, d, x[k + 13], S21, 0xA9E3E905);
                d = GG(d, a, b, c, x[k + 2], S22, 0xFCEFA3F8);
                c = GG(c, d, a, b, x[k + 7], S23, 0x676F02D9);
                b = GG(b, c, d, a, x[k + 12], S24, 0x8D2A4C8A);

                a = HH(a, b, c, d, x[k + 5], S31, 0xFFFA3942);
                d = HH(d, a, b, c, x[k + 8], S32, 0x8771F681);
                c = HH(c, d, a, b, x[k + 11], S33, 0x6D9D6122);
                b = HH(b, c, d, a, x[k + 14], S34, 0xFDE5380C);
                a = HH(a, b, c, d, x[k + 1], S31, 0xA4BEEA44);
                d = HH(d, a, b, c, x[k + 4], S32, 0x4BDECFA9);
                c = HH(c, d, a, b, x[k + 7], S33, 0xF6BB4B60);
                b = HH(b, c, d, a, x[k + 10], S34, 0xBEBFBC70);
                a = HH(a, b, c, d, x[k + 13], S31, 0x289B7EC6);
                d = HH(d, a, b, c, x[k], S32, 0xEAA127FA);
                c = HH(c, d, a, b, x[k + 3], S33, 0xD4EF3085);
                b = HH(b, c, d, a, x[k + 6], S34, 0x4881D05);
                a = HH(a, b, c, d, x[k + 9], S31, 0xD9D4D039);
                d = HH(d, a, b, c, x[k + 12], S32, 0xE6DB99E5);
                c = HH(c, d, a, b, x[k + 15], S33, 0x1FA27CF8);
                b = HH(b, c, d, a, x[k + 2], S34, 0xC4AC5665);

                a = II(a, b, c, d, x[k], S41, 0xF4292244);
                d = II(d, a, b, c, x[k + 7], S42, 0x432AFF97);
                c = II(c, d, a, b, x[k + 14], S43, 0xAB9423A7);
                b = II(b, c, d, a, x[k + 5], S44, 0xFC93A039);
                a = II(a, b, c, d, x[k + 12], S41, 0x655B59C3);
                d = II(d, a, b, c, x[k + 3], S42, 0x8F0CCC92);
                c = II(c, d, a, b, x[k + 10], S43, 0xFFEFF47D);
                b = II(b, c, d, a, x[k + 1], S44, 0x85845DD1);
                a = II(a, b, c, d, x[k + 8], S41, 0x6FA87E4F);
                d = II(d, a, b, c, x[k + 15], S42, 0xFE2CE6E0);
                c = II(c, d, a, b, x[k + 6], S43, 0xA3014314);
                b = II(b, c, d, a, x[k + 13], S44, 0x4E0811A1);
                a = II(a, b, c, d, x[k + 4], S41, 0xF7537E82);
                d = II(d, a, b, c, x[k + 11], S42, 0xBD3AF235);
                c = II(c, d, a, b, x[k + 2], S43, 0x2AD7D2BB);
                b = II(b, c, d, a, x[k + 9], S44, 0xEB86D391);

                a = addUnsigned(a, AA);
                b = addUnsigned(b, BB);
                c = addUnsigned(c, CC);
                d = addUnsigned(d, DD);
            }

            return wordToHex(a) + wordToHex(b) + wordToHex(c) + wordToHex(d);
        }

        initShortcuts() {
            document.getElementById('btn-arrow-up').addEventListener('click', () => {
                if (this.currentPtyId) {
                    const encoded = btoa('\x1b[A');
                    this.send({ type: MessageType.PTY_INPUT, ptyId: this.currentPtyId, data: encoded });
                }
            });

            document.getElementById('btn-arrow-down').addEventListener('click', () => {
                if (this.currentPtyId) {
                    const encoded = btoa('\x1b[B');
                    this.send({ type: MessageType.PTY_INPUT, ptyId: this.currentPtyId, data: encoded });
                }
            });

            document.getElementById('btn-arrow-right').addEventListener('click', () => {
                if (this.currentPtyId) {
                    const encoded = btoa('\x1b[C');
                    this.send({ type: MessageType.PTY_INPUT, ptyId: this.currentPtyId, data: encoded });
                }
            });

            document.getElementById('btn-arrow-left').addEventListener('click', () => {
                if (this.currentPtyId) {
                    const encoded = btoa('\x1b[D');
                    this.send({ type: MessageType.PTY_INPUT, ptyId: this.currentPtyId, data: encoded });
                }
            });

            document.getElementById('btn-enter').addEventListener('click', () => {
                if (this.currentPtyId) {
                    const encoded = btoa('\n');
                    this.send({ type: MessageType.PTY_INPUT, ptyId: this.currentPtyId, data: encoded });
                }
            });

            document.getElementById('btn-ctrl-c').addEventListener('click', () => {
                if (this.currentPtyId) {
                    const encoded = btoa('\x03');
                    this.send({ type: MessageType.PTY_INPUT, ptyId: this.currentPtyId, data: encoded });
                }
            });

            document.getElementById('btn-ctrl-v').addEventListener('click', async () => {
                try {
                    const text = await navigator.clipboard.readText();
                    if (this.currentPtyId && text) {
                        const encoded = btoa(unescape(encodeURIComponent(text)));
                        this.send({ type: MessageType.PTY_INPUT, ptyId: this.currentPtyId, data: encoded });
                    }
                } catch (e) {
                    console.error('粘贴失败:', e);
                }
            });
        }

        initThemeSelector() {
            const selector = document.getElementById('theme-select');
            selector.value = this.currentTheme;
            selector.addEventListener('change', (e) => {
                this.currentTheme = e.target.value;
                localStorage.setItem('webcli-theme', this.currentTheme);
                this.applyTheme();
            });
        }

        applyTheme() {
            const theme = themes[this.currentTheme];
            document.body.style.background = theme.background;
            document.getElementById('terminal-container').style.background = theme.background;
            this.terminals.forEach((term) => {
                term.options.theme = theme;
            });
        }

        connect() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${location.host}/ws`;
            this.ws = new WebSocket(wsUrl);
            this.wsAuthenticated = false;

            this.ws.onopen = () => {
                this.updateStatus(true);
                // 如果有 token，尝试自动认证
                if (this.authToken) {
                    this.authenticateWebSocket();
                } else {
                    this.showLoginDialog();
                }
            };

            this.ws.onmessage = (e) => {
                this.handleMessage(JSON.parse(e.data));
            };

            this.ws.onclose = () => {
                this.updateStatus(false);
                this.wsAuthenticated = false;
                setTimeout(() => this.connect(), 3000);
            };

            this.ws.onerror = (e) => console.error('WebSocket error:', e);
        }

        reattachAllTerminals() {
            if (this.terminals.size === 0) return;

            console.log('WebSocket 重连，重新 attach', this.terminals.size, '个终端');
            for (const ptyId of this.terminals.keys()) {
                // 清空终端内容，准备接收历史输出
                const term = this.terminals.get(ptyId);
                if (term) {
                    term.clear();
                }
                this.send({ type: MessageType.PTY_ATTACH, ptyId });
                // 重新发送当前终端大小
                if (term) {
                    this.send({
                        type: MessageType.PTY_RESIZE,
                        ptyId,
                        cols: term.cols,
                        rows: term.rows
                    });
                }
            }
        }

        handleMessage(msg) {
            switch (msg.type) {
                case MessageType.AUTH_SUCCESS:
                    this.handleAuthSuccess();
                    break;
                case MessageType.AUTH_FAILED:
                    this.handleAuthFailed(msg.data);
                    break;
                case MessageType.PTY_OUTPUT:
                    if (msg.ptyId && msg.data) {
                        const decoded = atob(msg.data);
                        const bytes = Uint8Array.from(decoded, c => c.charCodeAt(0));
                        const text = new TextDecoder('utf-8').decode(bytes);
                        const term = this.terminals.get(msg.ptyId);
                        if (term) {
                            term.write(text);
                        }
                    }
                    break;
                case MessageType.SUCCESS:
                    if (msg.ptyId && !this.terminals.has(msg.ptyId)) {
                        // 附加成功，创建终端
                        this.addTerminal(msg.ptyId);
                    }
                    break;
                case MessageType.PTY_VISIBILITY_DISABLED:
                    this.handleVisibilityDisabled(msg.ptyId);
                    break;
                case MessageType.ERROR:
                    console.error('Server error:', msg.data);
                    alert('错误: ' + msg.data);
                    break;
            }
        }

        handleAuthSuccess() {
            this.wsAuthenticated = true;
            // 重新 attach 所有已打开的终端
            this.reattachAllTerminals();
        }

        handleAuthFailed(message) {
            this.wsAuthenticated = false;
            // token 无效，清除并显示登录对话框
            this.authToken = null;
            localStorage.removeItem('webcli-auth-token');
            this.showLoginDialog();
            if (message && message !== '请先登录') {
                document.getElementById('login-error').textContent = message;
            }
        }

        handleVisibilityDisabled(ptyId) {
            const name = this.terminalNames.get(ptyId) || ptyId;
            // 清理本地终端
            this.terminals.get(ptyId)?.dispose();
            this.terminals.delete(ptyId);
            this.fitAddons.delete(ptyId);
            this.terminalNames.delete(ptyId);

            document.querySelector(`.tab[data-pty-id="${ptyId}"]`)?.remove();

            // 切换到其他终端
            if (this.currentPtyId === ptyId) {
                const firstPty = this.terminals.keys().next().value;
                if (firstPty) {
                    this.switchTerminal(firstPty);
                } else {
                    this.currentPtyId = null;
                    document.getElementById('terminal-container').innerHTML = '';
                }
            }

            // 提示用户
            alert(`终端 "${name}" 已被本地关闭远端可见`);
        }

        showPtyList() {
            if (!this.authToken) {
                this.showLoginDialog();
                return;
            }
            // 通过 HTTP API 获取终端列表
            fetch('/api/remote/terminals', {
                headers: { 'Authorization': `Bearer ${this.authToken}` }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success && result.data) {
                    this.displayPtyList(result.data);
                    document.getElementById('overlay').classList.add('show');
                    document.getElementById('pty-list').classList.add('show');
                } else {
                    if (result.message && result.message.includes('未登录')) {
                        this.authToken = null;
                        localStorage.removeItem('webcli-auth-token');
                        this.showLoginDialog();
                    } else {
                        alert('获取终端列表失败: ' + result.message);
                    }
                }
            })
            .catch(e => {
                console.error('获取终端列表失败:', e);
                alert('获取终端列表失败');
            });
        }

        hidePtyList() {
            document.getElementById('overlay').classList.remove('show');
            document.getElementById('pty-list').classList.remove('show');
        }

        displayPtyList(list) {
            const content = document.getElementById('pty-list-content');
            if (!list || list.length === 0) {
                content.innerHTML = '<div class="pty-list-empty">暂无可用终端</div>';
                return;
            }

            content.innerHTML = list.map(pty => {
                const [agentId, ptyId] = pty.id.split(':');
                const shortAgentId = agentId.substring(0, 8);
                return `
                    <div class="pty-list-item" data-pty-id="${pty.id}">
                        <span class="name">${pty.name}</span>
                        <span class="agent">Agent: ${shortAgentId}...</span>
                    </div>
                `;
            }).join('');

            content.querySelectorAll('.pty-list-item').forEach(item => {
                item.addEventListener('click', () => {
                    const ptyId = item.dataset.ptyId;
                    const name = item.querySelector('.name').textContent;
                    this.attachPty(ptyId, name);
                    this.hidePtyList();
                });
            });
        }

        attachPty(ptyId, name) {
            if (this.terminals.has(ptyId)) {
                this.switchTerminal(ptyId);
                return;
            }
            this.terminalNames.set(ptyId, name);
            this.send({ type: MessageType.PTY_ATTACH, ptyId });
        }

        addTerminal(ptyId) {
            const theme = themes[this.currentTheme];
            const term = new Terminal({
                cursorBlink: true,
                fontSize: 14,
                fontFamily: '"Maple Mono NF", "MesloLGS NF", "Hack Nerd Font", Menlo, Monaco, "Courier New", monospace',
                theme: theme,
                scrollback: 5000,
                smoothScrollDuration: 0
            });

            const fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
            this.terminals.set(ptyId, term);
            this.fitAddons.set(ptyId, fitAddon);

            term.onData(data => {
                const encoded = btoa(unescape(encodeURIComponent(data)));
                this.send({ type: MessageType.PTY_INPUT, ptyId, data: encoded });
            });

            // 自定义按键处理：Shift+Enter 发送换行符
            term.attachCustomKeyEventHandler((ev) => {
                if (ev.type === 'keydown' && ev.key === 'Enter' && ev.shiftKey && !ev.ctrlKey && !ev.altKey && !ev.metaKey) {
                    // Shift+Enter: 发送换行符
                    const encoded = btoa('\n');
                    this.send({ type: MessageType.PTY_INPUT, ptyId, data: encoded });
                    return false; // 阻止默认处理
                }
                return true; // 其他按键正常处理
            });

            term.onResize(({ cols, rows }) => {
                this.send({ type: MessageType.PTY_RESIZE, ptyId, cols, rows });
            });

            this.addTab(ptyId);
            this.switchTerminal(ptyId);
        }

        addTab(ptyId) {
            const tabs = document.getElementById('tabs');
            const tab = document.createElement('button');
            tab.className = 'tab';
            tab.dataset.ptyId = ptyId;
            const name = this.terminalNames.get(ptyId) || ptyId;
            tab.innerHTML = `<span class="tab-name">${name}</span><span class="close">×</span>`;

            tab.addEventListener('click', (e) => {
                if (e.target.classList.contains('close')) {
                    this.closePty(ptyId);
                } else {
                    this.switchTerminal(ptyId);
                }
            });

            tabs.appendChild(tab);
        }

        switchTerminal(ptyId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[data-pty-id="${ptyId}"]`)?.classList.add('active');

            const container = document.getElementById('terminal-container');
            container.innerHTML = '';

            const term = this.terminals.get(ptyId);
            const fitAddon = this.fitAddons.get(ptyId);
            if (term && fitAddon) {
                term.open(container);
                fitAddon.fit();
                term.focus();
                this.currentPtyId = ptyId;

                this.send({
                    type: MessageType.PTY_RESIZE,
                    ptyId,
                    cols: term.cols,
                    rows: term.rows
                });
            }
        }

        closePty(ptyId) {
            // 发送 DETACH 而不是 CLOSE，只断开远端连接，不关闭本地 PTY
            this.send({ type: MessageType.PTY_DETACH, ptyId });
            this.terminals.get(ptyId)?.dispose();
            this.terminals.delete(ptyId);
            this.fitAddons.delete(ptyId);
            this.terminalNames.delete(ptyId);

            document.querySelector(`.tab[data-pty-id="${ptyId}"]`)?.remove();

            if (this.currentPtyId === ptyId) {
                const firstPty = this.terminals.keys().next().value;
                if (firstPty) {
                    this.switchTerminal(firstPty);
                } else {
                    this.currentPtyId = null;
                }
            }
        }

        fitTerminal() {
            if (this.currentPtyId) {
                const fitAddon = this.fitAddons.get(this.currentPtyId);
                const term = this.terminals.get(this.currentPtyId);
                if (fitAddon && term) {
                    fitAddon.fit();
                    this.send({
                        type: MessageType.PTY_RESIZE,
                        ptyId: this.currentPtyId,
                        cols: term.cols,
                        rows: term.rows
                    });
                }
            }
        }

        send(msg) {
            if (this.ws?.readyState === WebSocket.OPEN) {
                this.ws.send(JSON.stringify(msg));
            }
        }

        updateStatus(connected) {
            const status = document.getElementById('status');
            status.textContent = connected ? '已连接' : '未连接';
            status.className = `status ${connected ? 'connected' : 'disconnected'}`;
        }
    }

    new RemoteTerminal();
</script>
</body>
</html>
